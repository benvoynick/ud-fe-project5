var model={googleMapSettings:{centerLat:30.287798,centerLng:-97.742345,zoom:16,searchBoundingBoxCoords:{sw:{lat:30.282309,lng:-97.742694},ne:{lat:30.291971,lng:-97.741153}}},googleSearchTypes:["bakery","bar","cafe","restaurant"],places:{},init:function(){var e=localStorage.getItem("dragMapPlaces");e?(e=JSON.parse(e),console.log("Stored data loaded"),console.log(e),console.log("end stored data"),this.places=e):console.log("Nothing stored in localStorage")},saveData:function(){var e=jQuery.extend(!0,{},this.places);for(var o in e)e.hasOwnProperty(o)&&delete e[o].googleData;console.log("Saving data"),localStorage.setItem("dragMapPlaces",JSON.stringify(e))},addPlace:function(e,o,a){return void 0!==this.places[e]?!1:(void 0===a&&(a={}),void 0!==o?a.placeName=o:a.placeName="NONAME!",a.id=e,this.places[e]=a,this.saveData(),!0)},updatePlace:function(e,o,a){if(void 0===this.places[e])return!1;void 0===a&&(a=!1);var l=!1;for(var t in o)if(o.hasOwnProperty(t)){if(this.places[e].hasOwnProperty(t)&&!a)return 2;this.places[e][t]=o[t],l=!0}return l&&this.saveData(),!0},checkUpdateDate:function(e,o,a){void 0===a&&(a=12);var l=36e5*a,t=new Date-this.places[e][o].receivedDate;return t>l?!0:!1}},viewModel=function(){var e=this;this.places=ko.observableArray(),this.selectedPlace=ko.observable(null),this.searchTerm=ko.observable(""),this.init=function(){model.init(),this.initGoogleMap(),this.searchGooglePlaces()},this.initView=function(){e.populatePlaces(),ko.applyBindings(e)},this.decorateModelPlaceData=function(o){o=jQuery.extend(!0,{},o),o.selected=ko.pureComputed(function(){return o.id==e.selectedPlace()?!0:!1},this),o.visible=ko.pureComputed(function(){var a=e.searchTerm().toLowerCase(),l=o.placeName.toLowerCase();return!a||o.selected()?!0:l.indexOf(a)>-1?!0:!1}),o.googleData.opening_hours&&o.googleData.opening_hours.open_now?o.openNow=ko.observable(!0):o.openNow=ko.observable(!1),o.googleRating=ko.observable(!1),o.googleWebsite=ko.observable(!1),o.googleMapsURL=ko.observable(!1);var a=o.googleData.geometry.location,l={map:e.googleMap,place:{location:a,placeId:o.id},title:o.placeName,visible:o.visible()};return o.openNow()||(l.icon={size:new google.maps.Size(48,48),url:"img/blue_marker.png"}),o.googleMapMarker=new google.maps.Marker(l),o.googleMapMarker.addListener("click",function(o){e.selectedPlace(this.place.placeId)}),o.googleInfoWindow=new google.maps.InfoWindow({content:""}),o.googleInfoWindow.addListener("closeclick",function(o){e.selectedPlace(null)}),o.visible.subscribe(function(e){o.googleMapMarker.setVisible(e)}),o.selected.subscribe(function(a){a?(o.oldMapMarkerIcon=o.googleMapMarker.getIcon(),o.googleMapMarker.setIcon({size:new google.maps.Size(42,42),url:"img/marker_pin.png"}),o.googleMapMarker.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){o.googleMapMarker.setAnimation(null)},2100),o.googleInfoWindow.setContent(jQuery("#iw-"+o.id).html()),o.googleInfoWindow.open(e.googleMap,o.googleMapMarker)):(o.googleMapMarker.setAnimation(null),o.googleMapMarker.setIcon(o.oldMapMarkerIcon),o.googleInfoWindow.close())}),o},this.updatePlace=function(o){model.places[o]&&(!model.places[o].googlePlaceData||model.checkUpdateDate(o,"googlePlaceData"))&&e.detailGooglePlace(o),places=e.places();for(var a=0;a<=places.length;a++){if(a==places.length){a=!1;break}if(places[a].id==o)break}if(a!==!1&&model.places[o]){var l=model.places[o];return l.googlePlaceData&&(l.googlePlaceData.rating&&places[a].googleRating(l.googlePlaceData.rating.toFixed(1)),l.googlePlaceData.website&&places[a].googleWebsite(l.googlePlaceData.website),l.googlePlaceData.url&&places[a].googleMapsURL(l.googlePlaceData.url)),places[a].googleInfoWindow.setContent(jQuery("#iw-"+places[a].id).html()),!0}return!1},this.populatePlaces=function(){var o=[];for(var a in model.places)if(model.places.hasOwnProperty(a)){var l=this.decorateModelPlaceData(model.places[a]);o.push(l)}e.places(o)},this.parseGoogleDetailRequest=function(o,a){if(console.log("Got place response: "+a),a==google.maps.places.PlacesServiceStatus.OK){for(var l=["place_id","formatted_address","formatted_phone_number","price_level","rating","url","website"],t={},s=0;s<l.length;s++)o.hasOwnProperty(l[s])&&(t[l[s]]=o[l[s]]);t.dateReceived=new Date,model.updatePlace(o.place_id,{googlePlaceData:t}),e.updatePlace(o.place_id)}else a==google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT?alert("Google maps data could not be loaded because this page has gone over its query limit. Please try again later."):a==google.maps.places.PlacesServiceStatus.INVALID_REQUEST?alert("ERROR: Google Maps received an invalid request."):a==google.maps.places.PlacesServiceStatus.ZERO_RESULTS?alert("ERROR: Google Maps did not find any restaurants."):a==google.maps.places.PlacesServiceStatus.UNKNOWN_ERROR?alert("ERROR: Google Maps encountered an unknown error."):alert("ERROR: Unknown status recevied from Google Maps")},this.parseGoogleSearchResults=function(o,a,l){if(a==google.maps.places.PlacesServiceStatus.OK){for(var t=0;t<o.length;t++)if(!o[t].permanently_closed){var s=o[t].place_id,n={googleData:o[t]};void 0===model.places[s]?model.addPlace(s,o[t].name,n):model.updatePlace(s,n,!1)}}else a==google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT?alert("Google maps data could not be loaded because this page has gone over its query limit. Please try again later."):a==google.maps.places.PlacesServiceStatus.INVALID_REQUEST?alert("ERROR: Google Maps received an invalid request."):a==google.maps.places.PlacesServiceStatus.ZERO_RESULTS?alert("ERROR: Google Maps did not find any restaurants."):a==google.maps.places.PlacesServiceStatus.UNKNOWN_ERROR?alert("ERROR: Google Maps encountered an unknown error."):alert("ERROR: Unknown status recevied from Google Maps");e.initView()},this.searchGooglePlaces=function(){var o=new google.maps.LatLng(model.googleMapSettings.searchBoundingBoxCoords.sw.lat,model.googleMapSettings.searchBoundingBoxCoords.sw.lng),a=new google.maps.LatLng(model.googleMapSettings.searchBoundingBoxCoords.ne.lat,model.googleMapSettings.searchBoundingBoxCoords.ne.lng),l=new google.maps.LatLngBounds(o,a),t={bounds:l,types:model.googleSearchTypes};e.googlePlacesService.nearbySearch(t,this.parseGoogleSearchResults)},this.detailGooglePlace=function(o){if(model.places.hasOwnProperty(o)){var a={placeId:o};e.googlePlacesService.getDetails(a,e.parseGoogleDetailRequest)}},this.getGoogleMapCenterCoords=function(){return[model.googleMapSettings.centerLat,model.googleMapSettings.centerLng]},this.getGoogleMapZoomLevel=function(){return model.googleMapSettings.zoom},this.initGoogleMap=function(){var e=this.getGoogleMapCenterCoords(),o={center:new google.maps.LatLng(e[0],e[1]),zoom:this.getGoogleMapZoomLevel()};this.googleMap=new google.maps.Map(document.getElementById("map"),o),this.googlePlacesService=new google.maps.places.PlacesService(this.googleMap)},this.selectPlace=function(o){currentPlace=e.selectedPlace(),currentPlace!=o.id?(e.updatePlace(o.id),e.selectedPlace(o.id)):e.selectedPlace(null)}};dragVM=new viewModel;